<script>
  // Função para carregar os relatos do localStorage
  function carregarRelatos() {
    const relatosSalvos = JSON.parse(localStorage.getItem('relatos')) || [];
    const relatosDiv = document.getElementById('relatos');
    relatosDiv.innerHTML = ''; // Limpa os relatos existentes na página
    relatosSalvos.forEach((relato) => {
      const relatoDiv = criarRelatoDiv(relato);
      relatosDiv.appendChild(relatoDiv);
    });
  }

  // Função para salvar os relatos no localStorage
  function salvarRelatos(relatos) {
    localStorage.setItem('relatos', JSON.stringify(relatos));
  }

  // Função para criar a estrutura HTML de um relato
  function criarRelatoDiv(relato) {
    const relatoDiv = document.createElement('div');
    relatoDiv.className = 'relato';

    // Nome e turma
    const autor = document.createElement('p');
    autor.textContent = `${relato.nome} - ${relato.turma}`;
    relatoDiv.appendChild(autor);

    // Relato
    const texto = document.createElement('p');
    texto.textContent = relato.texto;
    relatoDiv.appendChild(texto);

    // Foto ou vídeo (se houver)
    if (relato.foto) {
      if (relato.foto.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(relato.foto);
        relatoDiv.appendChild(img);
      } else if (relato.foto.type.startsWith('video/')) {
        const video = document.createElement('video');
        video.src = URL.createObjectURL(relato.foto);
        video.controls = true;
        relatoDiv.appendChild(video);
      }
    }

    // Botão de curtir (alternável)
    const likeBtn = document.createElement('button');
    likeBtn.className = 'like-btn';
    likeBtn.textContent = 'Curtir';
    let liked = relato.liked || false;
    let likeCount = relato.likeCount || 0;
    likeBtn.addEventListener('click', function () {
      liked = !liked;
      likeBtn.classList.toggle('liked', liked);
      likeCount = liked ? likeCount + 1 : likeCount - 1;
      likeCountSpan.textContent = likeCount;
      relato.liked = liked;
      relato.likeCount = likeCount;
      salvarRelatos(relatos);
    });
    relatoDiv.appendChild(likeBtn);

    // Contador de curtidas
    const likeCountSpan = document.createElement('span');
    likeCountSpan.className = 'like-count';
    likeCountSpan.textContent = likeCount;
    relatoDiv.appendChild(likeCountSpan);

    // Formulário de resposta
    const replyForm = document.createElement('form');
    replyForm.className = 'reply-form';
    const replyInput = document.createElement('textarea');
    replyInput.placeholder = 'Deixe uma resposta...';
    replyInput.rows = 2;
    replyForm.appendChild(replyInput);
    const replyBtn = document.createElement('button');
    replyBtn.type = 'submit';
    replyBtn.textContent = 'Responder';
    replyForm.appendChild(replyBtn);
    replyForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const replyText = replyInput.value;
      if (replyText) {
        const replyDiv = document.createElement('div');
        replyDiv.className = 'comment';
        const replyIndicator = document.createElement('div');
        replyIndicator.className = 'reply-indicator';
        replyIndicator.textContent = `${relato.nome} > ${autor.textContent}`;
        replyDiv.appendChild(replyIndicator);
        replyDiv.innerHTML += `<p>${replyText}</p>`;

        // Adicionar botão de curtir nas respostas
        const replyLikeBtn = document.createElement('button');
        replyLikeBtn.className = 'like-btn';
        replyLikeBtn.textContent = 'Curtir';
        let replyLiked = false;
        let replyLikeCount = 0;
        replyLikeBtn.addEventListener('click', function () {
          replyLiked = !replyLiked;
          replyLikeBtn.classList.toggle('liked', replyLiked);
          replyLikeCount = replyLiked ? replyLikeCount + 1 : replyLikeCount - 1;
          replyLikeCountSpan.textContent = replyLikeCount;
        });
        replyDiv.appendChild(replyLikeBtn);

        const replyLikeCountSpan = document.createElement('span');
        replyLikeCountSpan.className = 'like-count';
        replyLikeCountSpan.textContent = replyLikeCount;
        replyDiv.appendChild(replyLikeCountSpan);

        // Formulário de resposta para a resposta
        const nestedReplyForm = document.createElement('form');
        nestedReplyForm.className = 'reply-form';
        const nestedReplyInput = document.createElement('textarea');
        nestedReplyInput.placeholder = 'Responda à resposta...';
        nestedReplyInput.rows = 2;
        nestedReplyForm.appendChild(nestedReplyInput);
        const nestedReplyBtn = document.createElement('button');
        nestedReplyBtn.type = 'submit';
        nestedReplyBtn.textContent = 'Responder';
        nestedReplyForm.appendChild(nestedReplyBtn);
        nestedReplyForm.addEventListener('submit', function (e) {
          e.preventDefault();
          const nestedReplyText = nestedReplyInput.value;
          if (nestedReplyText) {
            const nestedReplyDiv = document.createElement('div');
            nestedReplyDiv.className = 'comment';
            nestedReplyDiv.innerHTML = `<p>${nestedReplyText}</p>`;
            replyDiv.appendChild(nestedReplyDiv);
            nestedReplyInput.value = '';
          }
        });
        replyDiv.appendChild(nestedReplyForm);

        relatoDiv.appendChild(replyDiv);

        // Adiciona a resposta ao relato
        relato.respostas = relato.respostas || [];
        relato.respostas.push({ texto: replyText });
        salvarRelatos(relatos);
        replyInput.value = '';
      }
    });
    relatoDiv.appendChild(replyForm);

    return relatoDiv;
  }

  // Função para adicionar relato e salvar no localStorage
  document.getElementById('relatoForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const nome = document.getElementById('nome').value;
    const turma = document.getElementById('turma').value;
    const relato = document.getElementById('relato').value;
    const foto = document.getElementById('foto').files[0];

    if (nome && turma && relato) {
      const relatos = JSON.parse(localStorage.getItem('relatos')) || [];
      const novoRelato = {
        nome: nome,
        turma: turma,
        texto: relato,
        foto: foto,
        liked: false,
        likeCount: 0,
        respostas: []
      };

      relatos.push(novoRelato);
      salvarRelatos(relatos);
      carregarRelatos(); // Atualiza a galeria de relatos

      alert('Relato enviado com sucesso!');
      document.getElementById('relatoForm').reset();
    }
  });

  // Carregar os relatos quando a página for carregada
  window.onload = function() {
    carregarRelatos();
    document.getElementById('passwordModal').style.display = 'flex';
  };

  // Verificar senha
  document.getElementById('passwordSubmit').addEventListener('click', function() {
    const password = document.getElementById('passwordInput').value;
    if (password === 'Escola25') {
      document.getElementById('passwordModal').style.display = 'none';
    } else {
      alert('Senha incorreta!');
    }
  });
</script>
